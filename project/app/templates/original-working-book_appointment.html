{% extends "base.html" %}

{% block content %}
<div class="container mt-5">
    <h2>Book Appointment with {{ tutor.username }}</h2>
    <p><strong>About:</strong> {{ tutor.about_me or "No bio available" }}</p>
    <p><strong>Email:</strong> {{ tutor.email }}</p>

    <!-- Calendar Navigation -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <button id="prev-week" class="btn btn-outline-primary btn-sm">&larr; Previous Week</button>
        <h5 id="current-week" class="text-center mb-0"></h5>
        <button id="next-week" class="btn btn-outline-primary btn-sm">Next Week &rarr;</button>
    </div>

    <!-- Calendar Table -->
    <div class="table-responsive-sm">
        <table class="table align-middle">
            <thead class="calendar-header">
                <tr>
                    {% for i in range(7) %}
                    <th scope="col" id="day-{{ i }}" class="day border fs-7">
                        <button class="clickable-day btn btn-link"></button>
                    </th>
                    {% endfor %}
                </tr>
            </thead>
        </table>
    </div>

    <!-- Selected Date and Availability -->
    <div class="mt-4">
        <p id="selected-date">Selected Date: None</p>
        <p id="selected-tutor">Tutor: {{ tutor.username }}</p>
        <p id="selected-day">Day of the Week: None</p>
    </div>

    <!-- Time Slot Dropdown -->
    <div class="form-group mb-3">
        <label for="time_slots">Select Time Slot:</label>
        <select id="time_slots" name="booking_time" class="form-control">
            <option value="" disabled selected>Select a time slot</option>
        </select>
    </div>

    <!-- Raw JSON Response -->
    <br>
    <p>The raw JSON returned is as follows:</p>
    <div id="rawJsonDiv"></div>

    <button type="submit" class="btn btn-primary">Book Appointment</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        let currentDate = new Date();

        // Function to calculate the start of the week
        function getStartOfWeek(date) {
            const startOfWeek = new Date(date);
            startOfWeek.setDate(date.getDate() - date.getDay());
            return startOfWeek;
        }

        // Function to update the calendar
        function updateCalendar(startOfWeek) {
            const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];

            // Populate the calendar header with days and dates
            for (let i = 0; i < 7; i++) {
                const dayElement = document.getElementById(`day-${i}`);
                const button = dayElement.querySelector('.clickable-day');
                const currentDay = new Date(startOfWeek);
                currentDay.setDate(startOfWeek.getDate() + i);

                // Format the date as "4/13" (month/day)
                const formattedDate = `${currentDay.getMonth() + 1}/${currentDay.getDate()}`;
                // Update the button text
                button.textContent = `${dayNames[i]} ${formattedDate}`;

                // Attach a click event listener to the button
                button.onclick = function () {
                    document.getElementById('selected-date').textContent = `Selected Date: ${formattedDate}`;
                    document.getElementById('selected-tutor').textContent = `Tutor: {{ tutor.username }}`;
                    document.getElementById('selected-day').textContent = `Day of the Week: ${dayNames[currentDay.getDay()]}`;

                    // Fetch and display availability for the selected date
                    fetchTimeSlots(formattedDate);
                };
            }

            // Update the current week display
            const weekStart = startOfWeek.toDateString();
            const weekEnd = new Date(startOfWeek);
            weekEnd.setDate(startOfWeek.getDate() + 6);
            document.getElementById('current-week').textContent = `${weekStart} - ${weekEnd.toDateString()}`;
        }

        // Function to fetch time slots
        function fetchTimeSlots(selectedDate) {
            const timeSlotsDropdown = document.getElementById('time_slots');
            const rawJsonDiv = document.getElementById('rawJsonDiv');
            const tutorId = {{ tutor.id }}; // Pass the tutor ID from the backend

            if (selectedDate) {
                const url = `/api/get_timeslots?tutor_id=${tutorId}&selected_date=${selectedDate}`;

                axios.get(url)
                    .then(function (response) {
                        // Populate the time slots dropdown
                        const availableTimes = response.data.available_times;
                        timeSlotsDropdown.innerHTML = '<option value="" disabled selected>Select a time slot</option>';
                        availableTimes.forEach(time => {
                            const option = document.createElement('option');
                            option.value = time;
                            option.textContent = time;
                            timeSlotsDropdown.appendChild(option);
                        });

                        // Display the raw JSON response
                        rawJsonDiv.innerHTML = JSON.stringify(response.data, null, 2);
                    })
                    .catch(function (error) {
                        console.error('Error fetching time slots:', error);
                        timeSlotsDropdown.innerHTML = '<option value="" disabled selected>No time slots available</option>';
                        rawJsonDiv.innerHTML = 'Error fetching data.';
                    });
            }
        }

        // Event listeners for week navigation
        document.getElementById('prev-week').onclick = function () {
            currentDate.setDate(currentDate.getDate() - 7);
            updateCalendar(getStartOfWeek(currentDate));
        };

        document.getElementById('next-week').onclick = function () {
            currentDate.setDate(currentDate.getDate() + 7);
            updateCalendar(getStartOfWeek(currentDate));
        };

        // Initialize the calendar
        updateCalendar(getStartOfWeek(currentDate));
    });
</script>
{% endblock %}